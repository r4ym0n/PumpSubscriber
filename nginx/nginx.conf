worker_processes auto;

env IPFS_GATEWAYS;
env IPFS_CONNECT_TIMEOUT_MS;
env IPFS_READ_TIMEOUT_MS;
env IPFS_DELAY_MS;
env IPFS_SSL_VERIFY;
env IPFS_DEBUG;
env IPFS_FALLBACK_ERROR;
env IPFS_MATCH_MIME_PREFIX;

error_log /dev/stderr info;

events {
  worker_connections 4096;
}

http {
  lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";
  resolver 127.0.0.11 1.1.1.1 8.8.8.8 ipv6=off valid=60s;

  # CA trust for lua SSL verification
  lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
  lua_ssl_verify_depth 5;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65s;
  keepalive_requests 1000;
  client_max_body_size 0;

  log_format timed '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                  'rt=$request_time uct=$upstream_connect_time uht=$upstream_header_time ust=$upstream_status';
  access_log /dev/stdout timed;

  include /usr/local/openresty/nginx/conf/conf.d/*.conf;
}
